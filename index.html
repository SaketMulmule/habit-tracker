<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker - Gamified Life</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Messages */
        .success-message {
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-info h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .xp-bar {
            margin-top: 15px;
        }

        .xp-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .xp-progress {
            height: 25px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        /* Streaks */
        .streaks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .streak-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .streak-card:hover {
            transform: translateY(-5px);
        }

        .streak-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .streak-icon {
            font-size: 2em;
        }

        .streak-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .streak-number {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin: 10px 0;
        }

        .streak-fire {
            font-size: 2.5em;
            text-align: center;
            animation: flicker 1.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .streak-label {
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        /* Week View */
        .week-view {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto; /* Allow horizontal scroll on mobile */
        }

        .week-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            gap: 10px;
            align-items: center;
            min-width: 700px; /* Ensure minimum width for all columns */
        }

        .week-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 0.85em;
        }

        .week-habit {
            font-weight: 600;
            color: #333;
            padding: 15px 10px;
        }

        .week-day {
            text-align: center;
            font-size: 2em;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: transform 0.2s;
        }

        .week-day:hover {
            transform: scale(1.1);
        }

        /* Personal Bests */
        .pb-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .pb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .pb-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            transition: transform 0.3s;
        }

        .pb-card:hover {
            transform: translateY(-5px);
        }

        .pb-muscle {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .pb-value {
            font-size: 2em;
            font-weight: bold;
        }

        .pb-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: left;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .action-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .action-subtitle {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .user-info h1 {
                font-size: 1.8em;
            }

            .week-view {
                padding: 20px;
            }

            .week-grid {
                grid-template-columns: 90px repeat(7, minmax(50px, 1fr));
                gap: 5px;
                font-size: 0.8em;
                min-width: 650px; /* Slightly smaller but shows all columns */
            }

            .week-header {
                font-size: 0.75em;
                padding: 8px 4px;
            }

            .week-habit {
                font-size: 0.9em;
                padding: 12px 5px;
            }

            .week-day {
                font-size: 1.3em;
                padding: 8px 4px;
            }

            .streaks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============================================
        // API CONFIGURATION
        // ============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxg7DmF7cYLUot3aWHLyhyqJhSjHf3lT6aLp4VR1dm-lEjXqv4v2onkQ5bO3hFJzHTuUA/exec';
        
        // OpenAI API Key - REPLACE THIS WITH YOUR ACTUAL KEY
        const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY_HERE';

        // ============================================
        // API FUNCTIONS
        // ============================================

        async function callAPI(action, data = {}) {
            const payload = { action, ...data };
            
            const response = await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for Apps Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Note: With no-cors, we can't read the response
            // So we'll always return success and rely on subsequent fetches
            return { success: true };
        }

        async function getAllData() {
            const response = await fetch(`${API_URL}?action=getAllData`);
            const result = await response.json();
            return result.data;
        }

        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const [month, day, year] = dateStr.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            try {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
            } catch (e) {}
            return null;
        }

        // ============================================
        // AI NUTRITION LOOKUP
        // ============================================

        async function getNutritionFromAI(foodDescription) {
            if (!OPENAI_API_KEY || OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                throw new Error('Please add your OpenAI API key');
            }

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a nutrition expert. Analyze food descriptions and return ONLY a JSON object with nutritional information. Be as accurate as possible based on typical serving sizes.'
                        },
                        {
                            role: 'user',
                            content: `Analyze this food and return ONLY a JSON object (no markdown, no explanation):
                            
"${foodDescription}"

Return format:
{
  "calories": <number>,
  "protein_g": <number>,
  "sugar_g": <number>
}

Example: {"calories": 250, "protein_g": 12, "sugar_g": 5}`
                        }
                    ],
                    temperature: 0.3,
                    max_tokens: 150
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'AI request failed');
            }

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            
            // Clean up response (remove markdown code blocks if present)
            const jsonStr = content.replace(/```json\n?|\n?```/g, '').trim();
            const nutritionData = JSON.parse(jsonStr);
            
            return {
                calories: nutritionData.calories || 0,
                protein: nutritionData.protein_g || 0,
                sugar: nutritionData.sugar_g || 0
            };
        }

        // ============================================
        // MAIN APP
        // ============================================

        function HabitTrackerApp() {
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [modalOpen, setModalOpen] = useState(null);
            
            const [data, setData] = useState({
                user: { name: "Fitness Warrior", level: 1, xp: 0, xpForNextLevel: 1300 },
                streaks: {
                    workout: { current: 0, longest: 0 },
                    meditation: { current: 0, longest: 0 },
                    calories: { current: 0, longest: 0 },
                    sugar: { current: 0, longest: 0 }
                },
                weekData: {
                    workout: Array(7).fill('‚ö™'),
                    meditation: Array(7).fill('‚ö™'),
                    calories: Array(7).fill('‚ö™'),
                    sugar: Array(7).fill('‚ö™')
                },
                personalBests: {
                    running: { speed: 0, date: '-' },
                    chest: { weight: 0, date: '-' },
                    legs: { weight: 0, date: '-' },
                    back: { weight: 0, date: '-' },
                    shoulder: { weight: 0, date: '-' },
                    arms: { weight: 0, date: '-' }
                }
            });

            useEffect(() => {
                loadData();
            }, []);

            async function loadData() {
                setIsLoading(true);
                setError(null);

                try {
                    const rawData = await getAllData();

                    const processed = processData(
                        rawData.workouts.slice(1),
                        rawData.meditation.slice(1),
                        rawData.food.slice(1),
                        rawData.profile.slice(1)
                    );
                    
                    setData(processed);

                } catch (err) {
                    setError(err.message);
                }

                setIsLoading(false);
            }

            function processData(workoutRows, meditationRows, foodRows, profileRows) {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                // User profile
                const profileMap = {};
                profileRows.forEach(row => {
                    if (row[0] && row[1] !== undefined) profileMap[row[0]] = row[1];
                });

                const user = {
                    name: profileMap['Name'] || "Fitness Warrior",
                    level: parseInt(profileMap['Level'] || 1),
                    xp: parseInt(profileMap['Total_XP'] || 0),
                    xpForNextLevel: (parseInt(profileMap['Level'] || 1) * 800) + 500
                };

                // Calculate 7-day data
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    last7Days.push(d.toISOString().split('T')[0]);
                }

                const weekData = {
                    workout: [],
                    meditation: [],
                    calories: [],
                    sugar: []
                };

                last7Days.forEach(date => {
                    // Workout
                    const hasWorkout = workoutRows.some(r => normalizeDate(r[1]) === date);
                    weekData.workout.push(hasWorkout ? 'üî•' : (date === todayStr ? '‚ö™' : '‚ùå'));

                    // Meditation
                    const medMins = meditationRows
                        .filter(r => normalizeDate(r[1]) === date)
                        .reduce((sum, r) => sum + (parseFloat(r[2]) || 0), 0);
                    weekData.meditation.push(medMins > 0 ? 'üî•' : (date === todayStr ? '‚ö™' : '‚ùå'));

                    // Food
                    const foodEntries = foodRows.filter(r => normalizeDate(r[1]) === date);
                    if (foodEntries.length === 0) {
                        weekData.calories.push(date === todayStr ? '‚ö™' : '‚ùå');
                        weekData.sugar.push(date === todayStr ? '‚ö™' : '‚ùå');
                    } else {
                        const cals = foodEntries.reduce((s, r) => s + (parseFloat(r[4]) || 0), 0);
                        const sugar = foodEntries.reduce((s, r) => s + (parseFloat(r[5]) || 0), 0);
                        weekData.calories.push(cals <= 2000 ? 'üî•' : '‚ùå');
                        weekData.sugar.push(sugar <= 25 ? 'üî•' : '‚ùå');
                    }
                });

                // Calculate streaks
                const calcStreak = (arr) => {
                    let streak = 0;
                    for (let i = 6; i >= 0; i--) {
                        if (arr[i] === 'üî•') streak++;
                        else if (arr[i] === '‚ùå') break;
                    }
                    return streak;
                };

                const streaks = {
                    workout: { current: calcStreak(weekData.workout), longest: calcStreak(weekData.workout) },
                    meditation: { current: calcStreak(weekData.meditation), longest: calcStreak(weekData.meditation) },
                    calories: { current: calcStreak(weekData.calories), longest: calcStreak(weekData.calories) },
                    sugar: { current: calcStreak(weekData.sugar), longest: calcStreak(weekData.sugar) }
                };

                // Personal bests
                const personalBests = {
                    running: { speed: 0, date: '-' },
                    chest: { weight: 0, date: '-' },
                    legs: { weight: 0, date: '-' },
                    back: { weight: 0, date: '-' },
                    shoulder: { weight: 0, date: '-' },
                    arms: { weight: 0, date: '-' }
                };

                workoutRows.forEach(row => {
                    const date = normalizeDate(row[1]);
                    const cat = row[2];
                    const muscle = row[3];
                    const weight = parseFloat(row[5]) || 0;
                    const speed = parseFloat(row[6]) || 0;

                    if (cat === 'Running' && speed > personalBests.running.speed) {
                        personalBests.running = { speed, date };
                    }

                    if (cat && (cat.includes('Strength') || cat === 'Strength')) {
                        const key = muscle ? muscle.toLowerCase() : null;
                        if (key && personalBests[key] && weight > personalBests[key].weight) {
                            personalBests[key] = { weight, date };
                        }
                    }
                });

                return { user, streaks, weekData, personalBests };
            }

            const handleSubmit = async (formData) => {
                try {
                    const id = Date.now().toString();
                    const date = formData.date || new Date().toISOString().split('T')[0];
                    let entry = [];
                    let type = '';

                    if (formData.type === 'workout') {
                        type = 'workout';
                        entry = [
                            id, date, formData.category,
                            formData.muscleGroup || '', formData.exerciseName || '',
                            formData.weight || '', formData.speed || '',
                            formData.distance || '', formData.duration || '', formData.notes || ''
                        ];
                    } else if (formData.type === 'meditation') {
                        type = 'meditation';
                        entry = [id, date, formData.duration, formData.meditationType || 'Mindfulness', formData.notes || ''];
                    } else if (formData.type === 'food') {
                        type = 'food';
                        entry = [id, date, formData.mealType, formData.foodItem, formData.calories, formData.sugar, formData.protein || '', formData.notes || ''];
                    }

                    await callAPI('addEntry', { type, entry });
                    
                    setSuccess('‚úÖ Entry added successfully! Refreshing...');
                    setModalOpen(null);
                    
                    // Wait a bit for Google Sheets to update
                    setTimeout(async () => {
                        await loadData();
                        setSuccess('‚úÖ Data refreshed!');
                        setTimeout(() => setSuccess(null), 2000);
                    }, 1500);

                } catch (err) {
                    setError('Failed to save: ' + err.message);
                    setTimeout(() => setError(null), 5000);
                }
            };

            const getDayLabel = (index) => ['D-6', 'D-5', 'D-4', 'D-3', 'D-2', 'D-1', 'Today'][index];

            if (isLoading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <div className="spinner"></div>
                            Loading your habits...
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    {/* Top Bar */}
                    <div className="top-bar">
                        <button className="refresh-btn" onClick={loadData}>
                            üîÑ Refresh Data
                        </button>
                    </div>

                    {/* Messages */}
                    {success && <div className="success-message">{success}</div>}
                    {error && <div className="error-message">‚ùå {error}</div>}

                    {/* Header */}
                    <div className="header">
                        <div className="header-top">
                            <div className="user-info">
                                <h1>üéÆ {data.user.name}</h1>
                                <div className="level-badge">
                                    <span>‚≠ê</span>
                                    <span>Level {data.user.level}</span>
                                </div>
                            </div>
                        </div>
                        <div className="xp-bar">
                            <div className="xp-label">
                                <span>Experience Points</span>
                                <span>{data.user.xp} / {data.user.xpForNextLevel} XP</span>
                            </div>
                            <div className="xp-progress">
                                <div 
                                    className="xp-fill" 
                                    style={{ width: `${Math.min((data.user.xp / data.user.xpForNextLevel) * 100, 100)}%` }}
                                >
                                    {Math.round((data.user.xp / data.user.xpForNextLevel) * 100)}%
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Streaks */}
                    <div className="streaks-grid">
                        {Object.entries(data.streaks).map(([key, value]) => {
                            const icons = { workout: 'üí™', meditation: 'üßò', calories: 'üçΩÔ∏è', sugar: 'üç¨' };
                            const titles = { workout: 'Workout', meditation: 'Meditation', calories: 'Calories', sugar: 'Sugar' };
                            return (
                                <div key={key} className="streak-card">
                                    <div className="streak-header">
                                        <span className="streak-icon">{icons[key]}</span>
                                        <span className="streak-title">{titles[key]}</span>
                                    </div>
                                    <div className="streak-number">{value.current}</div>
                                    <div className="streak-fire">üî•</div>
                                    <div className="streak-label">Best: {value.longest} days</div>
                                </div>
                            );
                        })}
                    </div>

                    {/* 7-Day View */}
                    <div className="week-view">
                        <div className="week-title">üìÖ 7-Day Streak Tracker</div>
                        <div className="week-grid">
                            <div className="week-header">Habit</div>
                            {[0,1,2,3,4,5,6].map(i => (
                                <div key={i} className="week-header">{getDayLabel(i)}</div>
                            ))}

                            <div className="week-habit">üí™ Workout</div>
                            {data.weekData.workout.map((status, i) => (
                                <div key={i} className="week-day">{status}</div>
                            ))}

                            <div className="week-habit">üßò Meditation</div>
                            {data.weekData.meditation.map((status, i) => (
                                <div key={i} className="week-day">{status}</div>
                            ))}

                            <div className="week-habit">üçΩÔ∏è Calories</div>
                            {data.weekData.calories.map((status, i) => (
                                <div key={i} className="week-day">{status}</div>
                            ))}

                            <div className="week-habit">üç¨ Sugar</div>
                            {data.weekData.sugar.map((status, i) => (
                                <div key={i} className="week-day">{status}</div>
                            ))}
                        </div>
                    </div>

                    {/* Personal Bests */}
                    <div className="pb-section">
                        <div className="week-title">üèÜ Personal Bests</div>
                        <div className="pb-grid">
                            <div className="pb-card">
                                <div className="pb-muscle">üèÉ Running</div>
                                <div className="pb-value">{data.personalBests.running.speed || 0}</div>
                                <div className="pb-label">mph</div>
                            </div>
                            {['chest', 'legs', 'back', 'shoulder', 'arms'].map(muscle => {
                                const icons = { chest: 'üí™', legs: 'ü¶µ', back: 'üîô', shoulder: 'üí™', arms: 'üí™' };
                                return (
                                    <div key={muscle} className="pb-card">
                                        <div className="pb-muscle">{icons[muscle]} {muscle.charAt(0).toUpperCase() + muscle.slice(1)}</div>
                                        <div className="pb-value">{data.personalBests[muscle]?.weight || 0}</div>
                                        <div className="pb-label">lbs</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div className="quick-actions">
                        <div className="week-title">‚ö° Quick Actions</div>
                        <div className="actions-grid">
                            <button className="action-card" onClick={() => setModalOpen('workout')}>
                                <div className="action-icon">üí™</div>
                                <div className="action-title">Log Workout</div>
                                <div className="action-subtitle">Track your training</div>
                            </button>

                            <button className="action-card" onClick={() => setModalOpen('meditation')}>
                                <div className="action-icon">üßò</div>
                                <div className="action-title">Log Meditation</div>
                                <div className="action-subtitle">Record your session</div>
                            </button>

                            <button className="action-card" onClick={() => setModalOpen('food')}>
                                <div className="action-icon">üçΩÔ∏è</div>
                                <div className="action-title">Log Food</div>
                                <div className="action-subtitle">Track calories & sugar</div>
                            </button>
                        </div>
                    </div>

                    {/* Modals */}
                    {modalOpen === 'workout' && (
                        <WorkoutModal 
                            onClose={() => setModalOpen(null)} 
                            onSubmit={handleSubmit}
                        />
                    )}
                    {modalOpen === 'meditation' && (
                        <MeditationModal 
                            onClose={() => setModalOpen(null)} 
                            onSubmit={handleSubmit}
                        />
                    )}
                    {modalOpen === 'food' && (
                        <FoodModal 
                            onClose={() => setModalOpen(null)} 
                            onSubmit={handleSubmit}
                        />
                    )}
                </div>
            );
        }

        // ============================================
        // MODAL COMPONENTS
        // ============================================

        function WorkoutModal({ onClose, onSubmit }) {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                category: 'Strength',
                muscleGroup: 'Chest',
                exerciseName: '',
                weight: '',
                speed: '',
                distance: '',
                duration: '',
                notes: ''
            });

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handleSubmit = () => {
                onSubmit({ type: 'workout', ...formData });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-title">üí™ Log Workout</div>
                        
                        <div className="form-group">
                            <label className="form-label">Date</label>
                            <input 
                                type="date" 
                                className="form-input"
                                value={formData.date}
                                onChange={e => handleChange('date', e.target.value)}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Category</label>
                            <select 
                                className="form-select"
                                value={formData.category}
                                onChange={e => handleChange('category', e.target.value)}
                            >
                                <option value="Strength">Strength Training</option>
                                <option value="Running">Running</option>
                            </select>
                        </div>

                        {formData.category === 'Strength' && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Muscle Group</label>
                                    <select 
                                        className="form-select"
                                        value={formData.muscleGroup}
                                        onChange={e => handleChange('muscleGroup', e.target.value)}
                                    >
                                        <option value="Chest">Chest</option>
                                        <option value="Legs">Legs</option>
                                        <option value="Back">Back</option>
                                        <option value="Shoulder">Shoulder</option>
                                        <option value="Arms">Arms</option>
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Exercise Name (Optional)</label>
                                    <input 
                                        type="text" 
                                        className="form-input"
                                        placeholder="e.g., Bench Press"
                                        value={formData.exerciseName}
                                        onChange={e => handleChange('exerciseName', e.target.value)}
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Weight (lbs)</label>
                                    <input 
                                        type="number" 
                                        className="form-input"
                                        placeholder="e.g., 185"
                                        value={formData.weight}
                                        onChange={e => handleChange('weight', e.target.value)}
                                    />
                                </div>
                            </>
                        )}

                        {formData.category === 'Running' && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Speed (mph)</label>
                                    <input 
                                        type="number" 
                                        step="0.1"
                                        className="form-input"
                                        placeholder="e.g., 7.5"
                                        value={formData.speed}
                                        onChange={e => handleChange('speed', e.target.value)}
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Distance (miles)</label>
                                    <input 
                                        type="number" 
                                        step="0.1"
                                        className="form-input"
                                        placeholder="e.g., 5.0"
                                        value={formData.distance}
                                        onChange={e => handleChange('distance', e.target.value)}
                                    />
                                </div>
                            </>
                        )}

                        <div className="form-group">
                            <label className="form-label">Duration (minutes)</label>
                            <input 
                                type="number" 
                                className="form-input"
                                placeholder="e.g., 45"
                                value={formData.duration}
                                onChange={e => handleChange('duration', e.target.value)}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Notes (Optional)</label>
                            <textarea 
                                className="form-textarea"
                                placeholder="How did it feel?"
                                value={formData.notes}
                                onChange={e => handleChange('notes', e.target.value)}
                            />
                        </div>

                        <div className="modal-buttons">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={handleSubmit}>Save Workout</button>
                        </div>
                    </div>
                </div>
            );
        }

        function MeditationModal({ onClose, onSubmit }) {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                duration: '',
                meditationType: 'Mindfulness',
                notes: ''
            });

            const handleSubmit = () => {
                onSubmit({ type: 'meditation', ...formData });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-title">üßò Log Meditation</div>
                        
                        <div className="form-group">
                            <label className="form-label">Date</label>
                            <input 
                                type="date" 
                                className="form-input"
                                value={formData.date}
                                onChange={e => setFormData(prev => ({ ...prev, date: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Duration (minutes)</label>
                            <input 
                                type="number" 
                                className="form-input"
                                placeholder="e.g., 20"
                                value={formData.duration}
                                onChange={e => setFormData(prev => ({ ...prev, duration: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Type</label>
                            <select 
                                className="form-select"
                                value={formData.meditationType}
                                onChange={e => setFormData(prev => ({ ...prev, meditationType: e.target.value }))}
                            >
                                <option value="Mindfulness">Mindfulness</option>
                                <option value="Guided">Guided</option>
                                <option value="Breathwork">Breathwork</option>
                                <option value="Body Scan">Body Scan</option>
                            </select>
                        </div>

                        <div className="form-group">
                            <label className="form-label">Notes (Optional)</label>
                            <textarea 
                                className="form-textarea"
                                placeholder="How did you feel?"
                                value={formData.notes}
                                onChange={e => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                            />
                        </div>

                        <div className="modal-buttons">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={handleSubmit}>Save Session</button>
                        </div>
                    </div>
                </div>
            );
        }

        function FoodModal({ onClose, onSubmit }) {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                mealType: 'Lunch',
                foodItem: '',
                calories: '',
                sugar: '',
                protein: '',
                notes: ''
            });

            const [isLoadingNutrition, setIsLoadingNutrition] = useState(false);
            const [nutritionError, setNutritionError] = useState(null);

            const handleGetNutrition = async () => {
                if (!formData.foodItem.trim()) {
                    setNutritionError('Please enter a food item first');
                    return;
                }

                setIsLoadingNutrition(true);
                setNutritionError(null);

                try {
                    const nutrition = await getNutritionFromAI(formData.foodItem);
                    setFormData(prev => ({
                        ...prev,
                        calories: nutrition.calories.toString(),
                        protein: nutrition.protein.toString(),
                        sugar: nutrition.sugar.toString()
                    }));
                } catch (err) {
                    setNutritionError(err.message || 'Failed to get nutrition info');
                } finally {
                    setIsLoadingNutrition(false);
                }
            };

            const handleSubmit = () => {
                onSubmit({ type: 'food', ...formData });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-title">üçΩÔ∏è Log Food</div>
                        
                        <div className="form-group">
                            <label className="form-label">Date</label>
                            <input 
                                type="date" 
                                className="form-input"
                                value={formData.date}
                                onChange={e => setFormData(prev => ({ ...prev, date: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Meal Type</label>
                            <select 
                                className="form-select"
                                value={formData.mealType}
                                onChange={e => setFormData(prev => ({ ...prev, mealType: e.target.value }))}
                            >
                                <option value="Breakfast">Breakfast</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Dinner">Dinner</option>
                                <option value="Snack">Snack</option>
                            </select>
                        </div>

                        <div className="form-group">
                            <label className="form-label">Food Item</label>
                            <input 
                                type="text" 
                                className="form-input"
                                placeholder="e.g., Grilled chicken salad, 2 eggs with toast"
                                value={formData.foodItem}
                                onChange={e => setFormData(prev => ({ ...prev, foodItem: e.target.value }))}
                            />
                            <button 
                                type="button"
                                className="btn btn-primary"
                                onClick={handleGetNutrition}
                                disabled={isLoadingNutrition}
                                style={{ marginTop: '10px', width: '100%' }}
                            >
                                {isLoadingNutrition ? '‚è≥ Getting nutrition info...' : 'ü§ñ Get Nutrition Info from AI'}
                            </button>
                            {nutritionError && (
                                <div style={{ color: '#f44336', marginTop: '8px', fontSize: '0.9em' }}>
                                    {nutritionError}
                                </div>
                            )}
                        </div>

                        <div className="form-group">
                            <label className="form-label">Calories</label>
                            <input 
                                type="number" 
                                className="form-input"
                                placeholder="e.g., 450"
                                value={formData.calories}
                                onChange={e => setFormData(prev => ({ ...prev, calories: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Sugar (grams)</label>
                            <input 
                                type="number" 
                                className="form-input"
                                placeholder="e.g., 5"
                                value={formData.sugar}
                                onChange={e => setFormData(prev => ({ ...prev, sugar: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Protein (grams) - Optional</label>
                            <input 
                                type="number" 
                                className="form-input"
                                placeholder="e.g., 30"
                                value={formData.protein}
                                onChange={e => setFormData(prev => ({ ...prev, protein: e.target.value }))}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Notes (Optional)</label>
                            <textarea 
                                className="form-textarea"
                                placeholder="Additional details"
                                value={formData.notes}
                                onChange={e => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                            />
                        </div>

                        <div className="modal-buttons">
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={handleSubmit}>Save Food Entry</button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<HabitTrackerApp />, document.getElementById('root'));
    </script>
</body>
</html>
